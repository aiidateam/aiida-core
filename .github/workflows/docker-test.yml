name: Test newly built images

on:
  workflow_call:
    inputs:
      runsOn:
        description: GitHub Actions Runner image
        required: true
        type: string
      images:
        description: Images built in build step
        required: true
        type: string
      target:
        description: Target image for testing
        required: true
        type: string

jobs:

  test:
    runs-on: ${{ inputs.runsOn }}
    timeout-minutes: 20
    defaults:
      run:
        # Make sure we fail if any command in a piped command sequence fails
        shell: bash -e -o pipefail {0}
        working-directory: .docker

    steps:

    - name: Checkout Repo âš¡ï¸
      uses: actions/checkout@v4

    - name: Login to GitHub Container Registry ğŸ”‘
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set Up Python ğŸ
      if: ${{ startsWith(inputs.runsOn, 'ubuntu') }}
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: pip

    - name: Install dependencies ğŸ“¦
      run: |
        pip install -r requirements.txt
        pip freeze

    - name: Run tests
      run: pytest -s
      env: ${{ fromJSON(inputs.images) }}
