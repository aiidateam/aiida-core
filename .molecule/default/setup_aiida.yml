- name: Set up AiiDa Environment
  hosts: all
  gather_facts: false

  # run as aiida user
  become: true
  become_method: "{{ become_method }}"
  become_user: "{{ aiida_user }}"

  environment:
    AIIDA_PATH: "{{ aiida_path }}"

  tasks:

  - name: reentry scan
    shell: "{{ venv_bin }}/reentry scan"
    changed_when: false

  - name: verdi quicksetup
    expect:
      command: >
        {{ venv_bin }}/verdi quicksetup
        --non-interactive
        --profile "{{ aiida_backend }}"
        --email "aiida@localhost"
        --first-name "ringo"
        --last-name "starr"
        --institution "the beatles"
        --db-backend "{{ aiida_backend }}"
      responses:
        ".*Use it?.*": "y"
      timeout: null
      creates: "{{ aiida_path }}/repository/{{ aiida_backend }}"

  - name: "Check if computer is already present"
    shell: "{{ venv_bin }}/verdi -p {{ aiida_backend }} computer show localhost"
    ignore_errors: true
    changed_when: false
    no_log: true
    register: aiida_check_computer

  - name: verdi computer setup localhost
    when: aiida_check_computer.rc != 0
    shell: >
      {{ venv_bin }}/verdi -p {{ aiida_backend }} computer setup
      --non-interactive
      --label "localhost"
      --description "this computer"
      --hostname "localhost"
      --transport local
      --scheduler direct
      --work-dir {{ aiida_path }}/local_work_dir/
      --mpirun-command "mpirun -np {tot_num_mpiprocs}"
      --mpiprocs-per-machine 1

  - name: verdi computer configure localhost
    when: aiida_check_computer.rc != 0
    shell: >
      {{ venv_bin }}/verdi -p {{ aiida_backend }} computer configure local "localhost"
      --non-interactive
      --safe-interval 0.0

  - name: verdi start daemon with {{ aiida_workers }} workers
    shell: "{{ venv_bin }}/verdi -p {{ aiida_backend }} daemon start {{ aiida_workers }}"

  - name: get verdi status
    shell: "{{ venv_bin }}/verdi -p {{ aiida_backend }} status"
    register: verdi_status
    changed_when: false

  - name: print verdi status
    debug:
      var: verdi_status.stdout
