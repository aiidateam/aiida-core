{% extends 'awi/base_ajax.html' %}

{% block ajax %}
<div class="modal-header">
	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	<h4 class="modal-title" id="renameLabel{{ computer_id }}">Rename computer {{ computer_id }}</h4>
</div>
<div class="modal-body">
	<div class="alert alert-danger" style="display: none;"></div>
	<div class="input-group">
		<input type="text" class="form-control">
		<span class="input-group-btn">
			<button class="btn btn-primary" type="button">Rename</button>
		</span>
	</div>
</div>
<script>
	(function() { /* we need to defer the script since jQuery is not yet loaded at that point of the page */
		var code = function($) { /* this is the jQuery code we need to execute */
			$(document).ready(function(){
				var themodal = $('#modal-{{ computer_id }}');
				var field = $('#modal-{{ computer_id }} input.form-control');
				field.val(themodal.attr('data-rename'));
				window.setTimeout(function(){
					field.select().focus(); /* we focus on the input field when the animation is over (just required for the first load, is then handled by the event show.bs.modal) */
				}, 500);
				$('#modal-{{ computer_id }} button.btn').click(function(){ /* submitting the form */
					$.ajax({ /* we call the api */
						url: themodal.attr('data-url'),
						type: 'PATCH',
						dataType: 'json',
						contentType: 'application/json',
						processData: false,
						data: '{"name":"'+field.val()+'"}',
						success: function(data) { /* on success, hide the modal and change the value in the table row */
							themodal.modal('toggle');
							$('#row-{{ computer_id }}>td.name>strong').text(data.name);
						},
						error: function(xhr, status, error){ /* on error, show an error message and focus on the field again */
							$('#modal-{{ computer_id }} .alert').html('<strong>Oops</strong>, there was a problem : '+$.parseJSON(xhr.responseText).dbcomputer.name).show();
							field.select().focus();
						}
					});
				});
				field.keypress(function(event) { /* on pressing the enter key, trigger the click event on the button (submit) */
					if (event.which == 13) {
						$('#modal-{{ computer_id }} button.btn').click();
					}
				});
				themodal.on('shown.bs.modal', function(e){ /* after apparition animation is complete, focus on the field */
					field.select().focus();
				});
				themodal.on('show.bs.modal', function(e){ /* if there was an error message, hide it on modal apparition */
					$('#modal-{{ computer_id }} .alert').hide();
				});
			});
		};
		var timer = function() { /* this is the timer function to defer code execution */
			if (window.jQuery) { /* if jQuery is available, ok lessgo */
				code(window.jQuery);
			} else { /* otherwise we defer for 100 milliseconds */
				window.setTimeout(timer, 100);
			}
		};
		timer();
	})();
</script>
{% endblock %}